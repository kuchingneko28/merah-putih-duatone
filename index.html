<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="./css/style.css" />
    <title>Merah Putih - Duotone</title>
  </head>
  <body>
    <div class="wrap">
      <div class="brand">
        <div class="flag" aria-hidden="true"></div>
        <h1>Merah Putih Duotone</h1>
      </div>

      <div class="card">
        <div class="grid">
          <section class="panel">
            <div id="drop" class="drop">
              <p>Drop an image, paste (Ctrl/‚åò+V), or</p>
              <label for="file" class="btn primary">Choose Image</label>
              <input id="file" type="file" accept="image/*" class="hidden-input" />
              <small class="hint">Your photo is linearly mapped to red (shadows) and white (highlights).</small>
            </div>

            <div class="preview">
              <canvas id="canvas" width="0" height="0" aria-label="Preview"></canvas>
            </div>
          </section>

          <aside class="panel sidebar">
            <div class="row">
              <button id="downloadBtn" class="btn primary" disabled>Download PNG</button>
              <button id="viewOriginalBtn" class="btn" disabled>View Original</button>
            </div>
            <small class="hint">Tip: Use ‚ÄúView Original‚Äù to compare before/after.</small>
          </aside>
        </div>
      </div>
      <footer class="footer">
        Created with <span class="love">‚ù§</span> by
        <a href="https://web.facebook.com/kuchingneko">Tuan Kuchiing üê±</a>
      </footer>
    </div>

    <script>
      const fileInput = document.getElementById("file");
      const dropZone = document.getElementById("drop");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d", { willReadFrequently: true });
      const downloadBtn = document.getElementById("downloadBtn");
      const viewBtn = document.getElementById("viewOriginalBtn");

      let origBitmap = null;
      let showOriginal = false;
      let originalName = "image";

      async function render() {
        if (!origBitmap) return;
        canvas.width = origBitmap.width;
        canvas.height = origBitmap.height;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (showOriginal) {
          ctx.drawImage(origBitmap, 0, 0);
          return;
        }

        ctx.drawImage(origBitmap, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const d = imageData.data;

        for (let i = 0; i < d.length; i += 4) {
          const r = d[i],
            g = d[i + 1],
            b = d[i + 2];
          const t = (0.299 * r + 0.587 * g + 0.114 * b) / 255; // luminance 0..1

          d[i] = 255; // R stays max (red)
          d[i + 1] = Math.round(255 * t); // G maps 0..255
          d[i + 2] = Math.round(255 * t); // B maps 0..255
        }

        ctx.putImageData(imageData, 0, 0);
      }

      async function loadFromFile(file) {
        if (!file || !file.type.startsWith("image/")) return;
        originalName = file.name.replace(/\.[^/.]+$/, ""); // strip extension
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = async () => {
          origBitmap = await createImageBitmap(img);
          URL.revokeObjectURL(url);
          showOriginal = false;
          await render();
          downloadBtn.disabled = false;
          viewBtn.disabled = false;
        };
        img.onerror = () => URL.revokeObjectURL(url);
        img.src = url;
      }

      // File picker
      fileInput.addEventListener("change", (e) => {
        const f = e.target.files?.[0];
        if (f) loadFromFile(f);
      });

      // Drag & drop
      ["dragenter", "dragover"].forEach((ev) => {
        dropZone.addEventListener(ev, (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.add("drag");
        });
      });
      ["dragleave", "drop"].forEach((ev) => {
        dropZone.addEventListener(ev, (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.remove("drag");
        });
      });
      dropZone.addEventListener("drop", (e) => {
        const f = e.dataTransfer?.files?.[0];
        if (f) loadFromFile(f);
      });

      // Paste from clipboard
      window.addEventListener("paste", (e) => {
        const item = [...(e.clipboardData?.items || [])].find((i) => i.type.startsWith("image/"));
        if (item) loadFromFile(item.getAsFile());
      });

      // Buttons
      downloadBtn.addEventListener("click", () => {
        if (!canvas.width || !canvas.height) return;
        const a = document.createElement("a");
        a.href = canvas.toDataURL("image/png");
        a.download = `${originalName}-edit.png`; // <-- dynamic name
        a.click();
      });

      viewBtn.addEventListener("click", () => {
        showOriginal = !showOriginal;
        viewBtn.textContent = showOriginal ? "View Processed" : "View Original";
        render();
      });
    </script>
  </body>
</html>
